<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Générateur de Tests</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aui/9.4.0/aui/aui-prototyping.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aui/9.4.0/aui/aui-prototyping.min.js"></script>
  <script src="https://connect-cdn.atl-paas.net/all.js"></script>
  <style>
    body { padding: 20px; }
    .hidden { display: none; }
    .loading { text-align: center; padding: 20px; }
    .format-selector { margin-bottom: 20px; }
    .test-results { 
      background-color: #f4f5f7; 
      border-radius: 3px;
      padding: 16px;
      white-space: pre-wrap;
      margin-top: 20px;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #0052CC;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <section id="content" class="ac-content">
    <h2>Générateur de Tests IA</h2>
    
    <div id="story-content" class="hidden">
      <div class="aui-message aui-message-info">
        <p class="title">
          <strong>User story à analyser:</strong>
        </p>
        <p id="story-text"></p>
      </div>
      
      <div class="format-selector">
        <form class="aui">
          <div class="radio">
            <input class="radio" type="radio" name="format" id="gherkin" value="gherkin" checked>
            <label for="gherkin">Format Gherkin (Given/When/Then)</label>
          </div>
          <div class="radio">
            <input class="radio" type="radio" name="format" id="detailed" value="detailed">
            <label for="detailed">Format détaillé (Étapes/Résultats attendus)</label>
          </div>
        </form>
      </div>
      
      <button id="generate-btn" class="aui-button aui-button-primary">Générer les tests</button>
    </div>
    
    <div id="loading" class="loading hidden">
      <div class="spinner"></div>
      <p>Génération des tests en cours...</p>
    </div>
    
    <div id="result-section" class="hidden">
      <h3>Tests générés:</h3>
      <div id="test-results" class="test-results"></div>
      
      <div style="margin-top: 20px;">
        <button id="copy-btn" class="aui-button">Copier</button>
        <button id="insert-btn" class="aui-button aui-button-primary">Ajouter à l'issue/page</button>
      </div>
    </div>
    
    <div id="error-message" class="hidden">
      <div class="aui-message aui-message-error">
        <p class="title">
          <strong>Erreur</strong>
        </p>
        <p id="error-text"></p>
      </div>
    </div>
  </section>

  <script>
    let contextData = {};
    
    // Initialiser et charger les données
    AP.context.getContext(function(context) {
      AP.dialog.getCustomData(function(data) {
        contextData = data;
        if (data) {
          const storyElement = document.getElementById('story-text');
          if (data.type === 'jira') {
            storyElement.textContent = data.summary + "\n\n" + data.description;
          } else if (data.type === 'confluence') {
            // Pour Confluence, nous avons besoin de traiter le HTML
            // Ce n'est qu'une représentation simple, un traitement plus complet
            // serait nécessaire pour une version production
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = data.pageContent;
            storyElement.textContent = data.pageTitle + "\n\n" + tempDiv.textContent;
          }
          
          document.getElementById('story-content').classList.remove('hidden');
        } else {
          showError("Impossible de récupérer les données de l'issue ou de la page.");
        }
      });
    });
    
    // Gestionnaire d'événements pour le bouton de génération
    document.getElementById('generate-btn').addEventListener('click', function() {
      const storyText = document.getElementById('story-text').textContent;
      const formatChoice = document.querySelector('input[name="format"]:checked').value;
      
      document.getElementById('story-content').classList.add('hidden');
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('result-section').classList.add('hidden');
      
      // Appel à votre API Flask
      fetch('/api/generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          story: storyText,
          format: formatChoice
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Erreur lors de l\'appel à l\'API');
        }
        return response.json();
      })
      .then(data => {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('result-section').classList.remove('hidden');
        document.getElementById('test-results').textContent = data.result;
      })
      .catch(error => {
        document.getElementById('loading').classList.add('hidden');
        showError(error.message);
      });
    });
    
    // Gestionnaire pour le bouton copier
    document.getElementById('copy-btn').addEventListener('click', function() {
      const testText = document.getElementById('test-results').textContent;
      navigator.clipboard.writeText(testText)
        .then(() => {
          // Feedback visuel temporaire
          this.textContent = '✓ Copié!';
          setTimeout(() => {
            this.textContent = 'Copier';
          }, 2000);
        })
        .catch(err => {
          showError('Impossible de copier: ' + err);
        });
    });
    
    // Gestionnaire pour le bouton d'insertion
    document.getElementById('insert-btn').addEventListener('click', function() {
      const testContent = document.getElementById('test-results').textContent;
      
      if (contextData.type === 'jira') {
        // Ajouter un commentaire à l'issue Jira
        AP.request({
          url: '/rest/api/latest/issue/' + contextData.issueKey + '/comment',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
            body: "h3. Tests générés automatiquement\n\n{noformat}\n" + testContent + "\n{noformat}"
          }),
          success: function() {
            AP.dialog.close();
          },
          error: function(xhr) {
            showError('Erreur lors de l\'ajout du commentaire: ' + xhr.responseText);
          }
        });
      } else if (contextData.type === 'confluence') {
        // Créer une nouvelle page Confluence en tant qu'enfant
        const pageTitle = "Tests pour " + contextData.pageTitle;
        
        AP.request({
          url: '/rest/api/content',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
            type: 'page',
            title: pageTitle,
            space: { key: contextData.spaceKey },
            ancestors: [{ id: contextData.pageId }],
            body: {
              storage: {
                value: "<h1>Tests générés automatiquement</h1><pre><code>" + 
                       testContent.replace(/</g, "&lt;").replace(/>/g, "&gt;") + 
                       "</code></pre>",
                representation: 'storage'
              }
            }
          }),
          success: function() {
            AP.dialog.close();
          },
          error: function(xhr) {
            showError('Erreur lors de la création de la page: ' + xhr.responseText);
          }
        });
      }
    });
    
    function showError(message) {
      document.getElementById('error-text').textContent = message;
      document.getElementById('error-message').classList.remove('hidden');
    }
  </script>
</body>
</html>